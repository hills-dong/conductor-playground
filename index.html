<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物品管理器 - AI 智能识别</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .upload-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #8b5cf6;
            background-color: #f5f3ff;
        }
        .card-enter {
            animation: cardEnter 0.3s ease-out;
        }
        @keyframes cardEnter {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8b5cf6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .generating-placeholder {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .item-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .item-card.selected {
            box-shadow: 0 0 0 3px #8b5cf6;
        }
        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .item-card.selected:hover {
            box-shadow: 0 0 0 3px #8b5cf6, 0 4px 12px rgba(0,0,0,0.15);
        }
        .style-btn {
            transition: all 0.2s ease;
        }
        .style-btn.active {
            background-color: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 16rem;
            height: 100vh;
            overflow-y: auto;
        }
        /* Main content */
        .main-content {
            margin-left: 16rem;
            min-height: 100vh;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Left Sidebar -->
    <aside class="sidebar bg-white border-r border-gray-200 p-4 flex flex-col">
        <!-- Logo -->
        <h1 class="text-lg font-bold text-purple-600 mb-4">物品管理器</h1>

        <!-- API Key Configuration -->
        <section id="apiKeySection" class="mb-4">
            <h2 class="text-sm font-semibold text-gray-700 mb-2">API Key</h2>
            <input
                type="password"
                id="apiKeyInput"
                placeholder="输入 Gemini API Key"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-2"
            >
            <button
                id="saveApiKeyBtn"
                class="w-full px-3 py-2 text-sm bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors"
            >
                保存
            </button>
            <p id="apiKeyStatus" class="mt-1 text-xs text-gray-500"></p>
            <p class="mt-1 text-xs text-gray-400">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-purple-500 hover:underline">获取 API Key</a>
            </p>
        </section>

        <!-- Image Upload -->
        <section id="uploadSection" class="flex-1 hidden">
            <h2 class="text-sm font-semibold text-gray-700 mb-2">上传照片</h2>
            <div
                id="uploadArea"
                class="upload-area rounded-lg p-4 text-center cursor-pointer"
            >
                <div id="uploadPlaceholder">
                    <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <p class="text-xs text-gray-600">点击或拖拽上传</p>
                </div>
                <img id="previewImage" class="max-h-40 mx-auto rounded-lg hidden" alt="预览">
            </div>
            <input type="file" id="fileInput" accept="image/jpeg,image/png" class="hidden">
            <div class="mt-3 space-y-2">
                <button
                    id="analyzeBtn"
                    class="w-full px-3 py-2 text-sm bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed hidden"
                >
                    开始识别
                </button>
                <button
                    id="resetBtn"
                    class="w-full px-3 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors hidden"
                >
                    重新上传
                </button>
            </div>
        </section>

        <!-- Progress -->
        <section id="progressSection" class="mt-4 hidden">
            <div class="flex items-center gap-2">
                <div class="spinner"></div>
                <span id="progressText" class="text-xs text-gray-600">正在识别...</span>
            </div>
        </section>
    </aside>

    <!-- Right Main Content -->
    <main class="main-content">
        <!-- Style Bar -->
        <div id="styleBar" class="sticky top-0 bg-white border-b border-gray-200 p-3 z-40 hidden">
            <div class="flex flex-wrap items-center gap-2 mb-2">
                <button id="selectAllBtn" class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">全选</button>
                <button id="deselectAllBtn" class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">取消</button>
                <span id="selectionCount" class="text-xs text-gray-500">已选 0 项</span>
                <div class="flex-1"></div>
                <button id="applyStyleBtn" class="px-3 py-1 text-sm bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:bg-gray-300 disabled:cursor-not-allowed">
                    应用风格
                </button>
            </div>
            <div class="flex flex-wrap gap-1.5" id="styleOptions">
                <button class="style-btn px-2 py-1 text-xs border border-gray-300 rounded active" data-style="kawaii">可爱萌系</button>
                <button class="style-btn px-2 py-1 text-xs border border-gray-300 rounded" data-style="pixel">像素</button>
                <button class="style-btn px-2 py-1 text-xs border border-gray-300 rounded" data-style="watercolor">水彩</button>
                <button class="style-btn px-2 py-1 text-xs border border-gray-300 rounded" data-style="flat">扁平</button>
                <button class="style-btn px-2 py-1 text-xs border border-gray-300 rounded" data-style="anime">动漫</button>
                <button class="style-btn px-2 py-1 text-xs border border-gray-300 rounded" data-style="sketch">素描</button>
                <button class="style-btn px-2 py-1 text-xs border border-gray-300 rounded" data-style="3d">3D</button>
                <button class="style-btn px-2 py-1 text-xs border border-gray-300 rounded" data-style="oilpaint">油画</button>
                <button class="style-btn px-2 py-1 text-xs border border-gray-300 rounded" data-style="pop">波普</button>
                <button class="style-btn px-2 py-1 text-xs border border-gray-300 rounded" data-style="lowpoly">低多边形</button>
                <button class="style-btn px-2 py-1 text-xs border border-gray-300 rounded" data-style="custom">自定义</button>
            </div>
            <div id="customStyleInput" class="mt-2 hidden">
                <input type="text" id="customPrompt" placeholder="输入自定义风格描述..."
                    class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
        </div>

        <!-- Results Grid -->
        <section id="resultsSection" class="p-4 hidden">
            <div id="itemsGrid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3">
                <!-- Items will be inserted here -->
            </div>
        </section>

        <!-- Empty State -->
        <div id="emptyState" class="flex items-center justify-center h-screen text-gray-400">
            <div class="text-center">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <p class="text-sm">上传照片开始识别物品</p>
            </div>
        </div>
    </main>

    <!-- Error Message -->
    <div id="errorMessage" class="fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg text-sm hidden">
        <span id="errorText"></span>
    </div>

    <script>
        // State
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let uploadedImage = null;
        let identifiedItems = [];
        let selectedItems = new Set();
        let selectedStyle = 'kawaii';

        // Style prompts
        const stylePrompts = {
            kawaii: "This image contains a {ITEM}. Transform ONLY the {ITEM} into a cute kawaii-style cartoon. White background. Remove ALL other objects, keep ONLY the {ITEM}. IMPORTANT: Preserve the original color scheme. Round shapes, big eyes if applicable, adorable chibi style like Sanrio characters.",
            pixel: "This image contains a {ITEM}. Transform ONLY the {ITEM} into pixel art style. White background. Remove ALL other objects, keep ONLY the {ITEM}. IMPORTANT: Preserve the original color scheme. 16-bit retro game aesthetic, blocky pixels, clear outlines.",
            watercolor: "This image contains a {ITEM}. Transform ONLY the {ITEM} into watercolor painting style. White background. Remove ALL other objects, keep ONLY the {ITEM}. IMPORTANT: Preserve the original color scheme. Soft brush strokes, gentle color blending, artistic hand-painted look.",
            flat: "This image contains a {ITEM}. Transform ONLY the {ITEM} into flat design illustration. White background. Remove ALL other objects, keep ONLY the {ITEM}. IMPORTANT: Preserve the original color scheme. Minimal details, solid colors, no gradients, clean geometric shapes, modern minimalist style.",
            anime: "This image contains a {ITEM}. Transform ONLY the {ITEM} into Japanese anime style. White background. Remove ALL other objects, keep ONLY the {ITEM}. IMPORTANT: Preserve the original color scheme. Clean lines, dramatic shading, manga-inspired aesthetic.",
            sketch: "This image contains a {ITEM}. Transform ONLY the {ITEM} into pencil sketch style. White background. Remove ALL other objects, keep ONLY the {ITEM}. Black and white pencil drawing, detailed line work, artistic shading, hand-drawn look.",
            '3d': "This image contains a {ITEM}. Transform ONLY the {ITEM} into 3D cartoon render style. White background. Remove ALL other objects, keep ONLY the {ITEM}. IMPORTANT: Preserve the original color scheme. Pixar/Disney 3D animation style, smooth surfaces, soft lighting.",
            oilpaint: "This image contains a {ITEM}. Transform ONLY the {ITEM} into oil painting style. White background. Remove ALL other objects, keep ONLY the {ITEM}. IMPORTANT: Preserve the original color scheme. Visible brush strokes, rich textures, classical painting aesthetic.",
            pop: "This image contains a {ITEM}. Transform ONLY the {ITEM} into pop art style. White background. Remove ALL other objects, keep ONLY the {ITEM}. Bold colors, Ben-Day dots, high contrast, Andy Warhol inspired.",
            lowpoly: "This image contains a {ITEM}. Transform ONLY the {ITEM} into low poly style. White background. Remove ALL other objects, keep ONLY the {ITEM}. IMPORTANT: Preserve the original color scheme. Geometric triangular facets, minimal polygons, modern 3D art style."
        };

        // DOM Elements
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const apiKeyStatus = document.getElementById('apiKeyStatus');
        const uploadSection = document.getElementById('uploadSection');
        const uploadArea = document.getElementById('uploadArea');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const fileInput = document.getElementById('fileInput');
        const previewImage = document.getElementById('previewImage');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resetBtn = document.getElementById('resetBtn');
        const progressSection = document.getElementById('progressSection');
        const progressText = document.getElementById('progressText');
        const resultsSection = document.getElementById('resultsSection');
        const itemsGrid = document.getElementById('itemsGrid');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const styleBar = document.getElementById('styleBar');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const selectionCount = document.getElementById('selectionCount');
        const applyStyleBtn = document.getElementById('applyStyleBtn');
        const customStyleInput = document.getElementById('customStyleInput');
        const customPrompt = document.getElementById('customPrompt');
        const emptyState = document.getElementById('emptyState');

        // Initialize
        function init() {
            if (apiKey) {
                apiKeyInput.value = apiKey;
                apiKeyStatus.textContent = '已保存';
                apiKeyStatus.className = 'mt-1 text-xs text-green-600';
                uploadSection.classList.remove('hidden');
            }
            setupEventListeners();
        }

        function setupEventListeners() {
            saveApiKeyBtn.addEventListener('click', saveApiKey);
            apiKeyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveApiKey();
            });

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);

            analyzeBtn.addEventListener('click', analyzeImage);
            resetBtn.addEventListener('click', resetUpload);

            document.querySelectorAll('#styleOptions .style-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#styleOptions .style-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedStyle = btn.dataset.style;
                    customStyleInput.classList.toggle('hidden', selectedStyle !== 'custom');
                });
            });

            selectAllBtn.addEventListener('click', selectAll);
            deselectAllBtn.addEventListener('click', deselectAll);
            applyStyleBtn.addEventListener('click', applyStyleToSelected);
        }

        function updateSelectionCount() {
            selectionCount.textContent = `已选 ${selectedItems.size} 项`;
            applyStyleBtn.disabled = selectedItems.size === 0;
        }

        function toggleItemSelection(index) {
            if (selectedItems.has(index)) {
                selectedItems.delete(index);
            } else {
                selectedItems.add(index);
            }
            updateCardSelection(index);
            updateSelectionCount();
        }

        function selectAll() {
            identifiedItems.forEach((_, index) => {
                selectedItems.add(index);
                updateCardSelection(index);
            });
            updateSelectionCount();
        }

        function deselectAll() {
            const itemsToDeselect = Array.from(selectedItems);
            selectedItems.clear();
            itemsToDeselect.forEach(index => updateCardSelection(index));
            updateSelectionCount();
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (!key) {
                showError('请输入 API Key');
                return;
            }
            apiKey = key;
            localStorage.setItem('gemini_api_key', key);
            apiKeyStatus.textContent = '已保存';
            apiKeyStatus.className = 'mt-1 text-xs text-green-600';
            uploadSection.classList.remove('hidden');
        }

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }

        function handleFile(file) {
            if (!file.type.match(/^image\/(jpeg|png)$/)) {
                showError('请上传 JPG 或 PNG 格式的图片');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImage = e.target.result;
                previewImage.src = uploadedImage;
                previewImage.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
                analyzeBtn.classList.remove('hidden');
                resetBtn.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function resetUpload() {
            uploadedImage = null;
            previewImage.src = '';
            previewImage.classList.add('hidden');
            uploadPlaceholder.classList.remove('hidden');
            analyzeBtn.classList.add('hidden');
            resetBtn.classList.add('hidden');
            fileInput.value = '';
            resultsSection.classList.add('hidden');
            styleBar.classList.add('hidden');
            emptyState.classList.remove('hidden');
            itemsGrid.innerHTML = '';
            identifiedItems = [];
            selectedItems.clear();
        }

        async function analyzeImage() {
            if (!uploadedImage || !apiKey) return;

            analyzeBtn.disabled = true;
            progressSection.classList.remove('hidden');
            progressText.textContent = '正在识别...';

            try {
                const base64Data = uploadedImage.split(',')[1];
                const mimeType = uploadedImage.split(';')[0].split(':')[1];

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {
                                    text: `Analyze this photo and identify all objects. Return a JSON array with each object having:
- name: Chinese name
- nameEn: English name
- description: Brief Chinese description
- bbox: Bounding box as [x, y, width, height] in percentage (0-100) of image dimensions

Return ONLY the JSON array, no other text. Example:
[{"name":"电脑","nameEn":"computer","description":"一台电脑","bbox":[10,20,30,25]}]`
                                },
                                { inline_data: { mime_type: mimeType, data: base64Data } }
                            ]
                        }],
                        generationConfig: { temperature: 0.1, maxOutputTokens: 8192 }
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || '识别失败');
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;

                let jsonStr = text;
                const codeBlockMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (codeBlockMatch) jsonStr = codeBlockMatch[1].trim();

                let startIdx = jsonStr.indexOf('[');
                if (startIdx === -1) throw new Error('无法解析识别结果');

                let depth = 0, endIdx = -1;
                for (let i = startIdx; i < jsonStr.length; i++) {
                    if (jsonStr[i] === '[') depth++;
                    if (jsonStr[i] === ']') depth--;
                    if (depth === 0) { endIdx = i; break; }
                }

                if (endIdx === -1) throw new Error('无法解析识别结果');

                let cleanJson = jsonStr.substring(startIdx, endIdx + 1)
                    .replace(/,\s*]/g, ']')
                    .replace(/,\s*}/g, '}')
                    .replace(/[\x00-\x1F\x7F]/g, ' ');

                identifiedItems = JSON.parse(cleanJson);
                if (!identifiedItems.length) throw new Error('未识别到任何物品');

                displayItems();

            } catch (error) {
                showError(error.message);
            } finally {
                analyzeBtn.disabled = false;
                progressSection.classList.add('hidden');
            }
        }

        function displayItems() {
            resultsSection.classList.remove('hidden');
            styleBar.classList.remove('hidden');
            emptyState.classList.add('hidden');
            itemsGrid.innerHTML = '';
            selectedItems.clear();
            updateSelectionCount();

            const img = new Image();
            img.onload = () => {
                identifiedItems.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.id = `card-${index}`;
                    card.className = 'item-card bg-white rounded-lg shadow overflow-hidden card-enter';
                    card.style.animationDelay = `${index * 0.05}s`;

                    let croppedDataUrl = '';
                    if (item.bbox && item.bbox.length === 4) {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        const x = (item.bbox[0] / 100) * img.width;
                        const y = (item.bbox[1] / 100) * img.height;
                        const w = (item.bbox[2] / 100) * img.width;
                        const h = (item.bbox[3] / 100) * img.height;

                        const maxSize = 512;
                        let targetW = w, targetH = h;
                        if (w > maxSize || h > maxSize) {
                            const scale = Math.min(maxSize / w, maxSize / h);
                            targetW = Math.round(w * scale);
                            targetH = Math.round(h * scale);
                        }

                        canvas.width = targetW;
                        canvas.height = targetH;
                        ctx.drawImage(img, x, y, w, h, 0, 0, targetW, targetH);
                        croppedDataUrl = canvas.toDataURL('image/jpeg', 0.85);
                    }

                    item.croppedDataUrl = croppedDataUrl;

                    card.innerHTML = `
                        <div class="aspect-square bg-gray-100 flex items-center justify-center overflow-hidden relative" id="image-${index}">
                            ${croppedDataUrl
                                ? `<img src="${croppedDataUrl}" class="w-full h-full object-contain" alt="${item.name}">`
                                : `<svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>`
                            }
                            <div class="absolute top-1 right-1 w-5 h-5 rounded-full border-2 border-white bg-white/80 flex items-center justify-center check-mark">
                                <svg class="w-3 h-3 text-purple-500 hidden" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="p-2">
                            <h3 class="text-xs font-medium text-gray-800 truncate">${item.name}</h3>
                        </div>
                    `;

                    card.addEventListener('click', () => toggleItemSelection(index));
                    itemsGrid.appendChild(card);
                });
            };
            img.src = uploadedImage;
        }

        function updateCardSelection(index) {
            const card = document.getElementById(`card-${index}`);
            if (card) {
                const checkMark = card.querySelector('.check-mark svg');
                if (selectedItems.has(index)) {
                    card.classList.add('selected');
                    if (checkMark) checkMark.classList.remove('hidden');
                } else {
                    card.classList.remove('selected');
                    if (checkMark) checkMark.classList.add('hidden');
                }
            }
        }

        async function applyStyleToSelected() {
            if (selectedItems.size === 0) {
                showError('请先选择要风格化的物品');
                return;
            }

            const itemsToProcess = Array.from(selectedItems);
            applyStyleBtn.disabled = true;
            applyStyleBtn.textContent = `0/${itemsToProcess.length}`;

            const batchSize = 3;
            let processed = 0;

            for (let i = 0; i < itemsToProcess.length; i += batchSize) {
                const batch = itemsToProcess.slice(i, i + batchSize);
                await Promise.all(batch.map(async (index) => {
                    await generateCartoon(index);
                    processed++;
                    applyStyleBtn.textContent = `${processed}/${itemsToProcess.length}`;
                }));
            }

            applyStyleBtn.textContent = '应用风格';
            applyStyleBtn.disabled = selectedItems.size === 0;
        }

        async function generateCartoon(index) {
            const item = identifiedItems[index];
            if (!item || !item.croppedDataUrl) return;

            const imageContainer = document.getElementById(`image-${index}`);
            if (!imageContainer) return;

            const originalContent = imageContainer.innerHTML;
            imageContainer.innerHTML = `
                <div class="generating-placeholder w-full h-full flex items-center justify-center">
                    <div class="spinner"></div>
                </div>
            `;

            try {
                const base64Data = item.croppedDataUrl.split(',')[1];
                const mimeType = item.croppedDataUrl.split(';')[0].split(':')[1];

                let prompt;
                if (selectedStyle === 'custom') {
                    const customText = customPrompt.value.trim();
                    if (!customText) throw new Error('请输入自定义风格描述');
                    prompt = `This image contains a {ITEM}. Transform ONLY the {ITEM} into ${customText}. White background. Remove ALL other objects, keep ONLY the {ITEM}. IMPORTANT: Preserve the original color scheme.`;
                } else {
                    prompt = stylePrompts[selectedStyle];
                }
                prompt = prompt.replace(/\{ITEM\}/g, item.nameEn || item.name);

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inline_data: { mime_type: mimeType, data: base64Data } }
                            ]
                        }],
                        generationConfig: {
                            responseModalities: ["IMAGE"],
                            imageConfig: { aspectRatio: "1:1" }
                        }
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || '生成失败');
                }

                const data = await response.json();
                const parts = data.candidates?.[0]?.content?.parts || [];
                const imagePart = parts.find(p => p.inlineData);

                if (imagePart && imagePart.inlineData) {
                    const imageData = imagePart.inlineData.data;
                    const outputMimeType = imagePart.inlineData.mimeType || 'image/png';
                    imageContainer.innerHTML = `
                        <img src="data:${outputMimeType};base64,${imageData}" class="w-full h-full object-contain" alt="${item.name}">
                        <div class="absolute top-1 right-1 w-5 h-5 rounded-full border-2 border-white bg-white/80 flex items-center justify-center check-mark">
                            <svg class="w-3 h-3 text-purple-500 ${selectedItems.has(index) ? '' : 'hidden'}" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    `;
                } else {
                    throw new Error('未能生成图片');
                }
            } catch (error) {
                console.error('Cartoon generation error:', error);
                showError(`${item.name}: ${error.message}`);
                imageContainer.innerHTML = originalContent;
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => errorMessage.classList.add('hidden'), 5000);
        }

        init();
    </script>
</body>
</html>
